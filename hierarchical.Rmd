# Hierarchical Models

- *Hierarchical models:* often groups of parameters, $\{\theta_1, \dots, \theta_J\}$, are related.
- E.g. countries, states, counties, years, etc. Even the regression coefficients, $\beta_1, \dots, \beta_k$ seen the in the [Shrinkage and Regularization] chapter.
- We can treat those $\theta_j$ as drawn from a *population distribution*, $\theta_j \sim p(\theta)$.
- The prior distribution $p(\theta)$ is called a *hyperprior* and its parameters are *hyperparameters*


*Exchangeability:*

- parameters $(\theta_1, \dots, \theta_J)$ are *exchangeable* if $p(\theta_1, \dots, \theta_J)$ don't depend on the indexes.
- i.i.d. models are a special case of exchangeability.


## Baseball Hitting

@EfronMorris1975a analyzed data from 18 players in the 1970 season.
The goal was to predict the batting average of these 18 players from their first 45 at-bats for the remainder of the 1970 season.

The following example is based on @CarpenterGabryGoodrich2017a and the `r rpkg("rstanarm")` vignette [Hierarchical Partial Pooling for Repeated Binary Trials](https://cran.r-project.org/web/packages/rstanarm/vignettes/pooling.html).


The hitting data used in @EfronMorris1975a is included in `r rpkg("rstanarm")` as `r rdoc("rstanarm", "bball1970")`:
```{r}
data("bball1970", package = "rstanarm")
bball1970 <-
  mutate(bball1970,
         BatAvg1 = Hits / AB,
         BatAvg2 = RemainingHits / RemainingAB)
bball1970
```

Let $y_i$ be the number of hits in the first 45 at bats for player $i$,
$$
\begin{aligned}[t]
y_i & \sim \dbin(45, \mu_i),
\end{aligned}
$$
where $\mu_i \in (0, 1)$ is the player-specific batting average.
Priors will be placed on the log-odds parameter, $\eta \in \R$,
$$
\begin{aligned}[t]
\mu_i &\sim \frac{1}{1 + \exp(-\eta_i)} . \\
\end{aligned}
$$

This example considers three ways of modeling $\mu_i$:


1. **Complete Pooling:** All players have the same batting average parameter.
    $$
    \eta_i = \eta .
    $$
    The common (log-odds) batting average is given a weakly informative prior,
    $$
    \eta \sim \dnorm(0, 2.5)
    $$
    On the log odds scale, this places 95% of the probability mass between `r round(plogis(-5) * 100, 1)` and `r round(plogis(5) * 100, 1)` on the proportion scale.
    
2. **Non-pooled:** Each players (log-odds) batting average is independent, with each assigned a separate weak prior.
    $$
    \begin{aligned}[t]
    \eta_i &\sim \dnorm(0, 2.5)
    \end{aligned}
    $$

3. **Partial-pooling:** Each player has a separate (log-odds) batting average, but these batting average parameters are drawn from a common normal distribution.
    $$
    \begin{aligned}[t]
    \eta_i &\sim \dnorm(0, \tau) \\
    \tau &\sim \dnorm(0, 1)
    \end{aligned}
    $$

```{r}
bball1970_data <- list(
  N = nrow(bball1970),
  k = bball1970$AB,
  y = bball1970$Hits,
  k_new = bball1970$RemainingAB,
  y_new = bball1970$RemainingHits
)
```
Create a list to store models:
```{r}
models <- list()
```

```{r results='hide'}
models[["nopool"]] <- stan_model("stan/binomial-no-pooling.stan")
```
```{r}
models[["nopool"]]
```


```{r results='hide'}
models[["pool"]] <- stan_model("stan/binomial-complete-pooling.stan")
```
```{r}
models[["pool"]]
```

```{r results='hide'}
models[["partial"]] <- stan_model("stan/binomial-partial-pooling-t.stan")
```
```{r}
models[["partial"]]
```

Sample from all three models a
```{r results='hide'}
fits <- map(models, sampling, data = bball1970_data,
            refresh = -1) %>%
  set_names(names(models))
```

For each model calculate the posterior mean of $\mu$ for each player:
```{r}
bball1970 <-
  map2_df(names(fits), fits, 
     function(nm, fit) {
      mu <- broom::tidy(fit) %>% filter(str_detect(term, "^mu"))
      if (nrow(mu) == 1) {
        out <- tibble(estimate = rep(mu$estimate, 18L))
      } else {
        out <- select(mu, estimate)
      }
      out$model <- nm
      out$.id <- seq_len(nrow(out))
      out
     }) %>%
  spread(model, estimate) %>%
  bind_cols(bball1970)
```
The partially pooled estiamtes are shrunk towards the overall average, and are between the no-pooling and pooled estimates.
```{r}
select(bball1970,
       Player, nopool, partial, pool) %>% 
  mutate(Player = factor(Player, levels = Player)) %>%
  gather(variable, value, -Player) %>%
  ggplot(aes(y = value, x = factor(variable), group = Player)) +
  geom_point() +
  geom_line() +
  labs(x = "", y = expression(mu))
```
We can plot the actual batting averages (`BatAvg1` and `BatAvg2`) and the model estimates:
```{r}
select(bball1970,
       Player, nopool, partial, pool, BatAvg1, BatAvg2) %>%
  mutate(Player = factor(Player, levels = Player)) %>%
  gather(variable, value, -Player) %>%
  ggplot(aes(y = Player, x = value, colour = variable)) +
  geom_point() +
  labs(x = expression(mu), y = "")
```
The estimates of the no-pooling model is almost exactly the same as `BatAvg1`.
The out-of-sample batting averages `BatAvg2` show regression to the mean.

For these models, compare the overall out-of-sample performance by calculating the actual average out-of-sample log-pointwise predictive density (lppd), and the expected lppd using LOO-PSIS.
The LOO-PSIS estimates of the out-of-sample lppd are optimistic.
However, they still show the pooling and partial estimates as superior to the no-pooling estimates.
The actual out-of-sample average lppd for the partial pooled model is the best fitting.
```{r warning=FALSE,message=FALSE}
map2_df(names(fits), fits, 
     function(nm, fit) {
      loo <- loo(extract_log_lik(fit, "log_lik"))
      ll_new <- rstan::extract(fit)[["log_lik_new"]]
      tibble(model = nm,
             loo = loo$elpd_loo / bball1970_data$N,
             ll_out = mean(log(colMeans(exp(ll_new)))))
     })
```

To see why this is the case, plot the average errors for each observation in- and out-of-sample.
In-sample for the no-pooling model is zero, but it over-estimates (under-estimates) the players with the highest (lowest) batting averages in their first 45 at bats---this is regression to the mean.
In sample, the partially pooling model shrinks the estimates towards the mean and 
reducing error.
Out of sample, the errors of the partially pooled model are not much different than the no-pooling model, except that the extreme observations have lower errors.
```{r}
select(bball1970,
       Player, nopool, partial, pool, BatAvg1, BatAvg2) %>% 
  mutate(Player = as.integer(factor(Player, levels = Player))) %>%
  gather(variable, value, -Player, -matches("BatAvg")) %>%
  mutate(`In-sample Errors` = value - BatAvg1,
         `Out-of-sample Errors` = value - BatAvg2) %>%
  select(-matches("BatAvg"), -value) %>%
  gather(sample, error, -variable, -Player) %>%
  ggplot(aes(y = error, x = Player, colour = variable)) +
  geom_hline(yintercept = 0, colour = "white", size = 2) +
  geom_point() +
  geom_line() +
  facet_wrap(~ sample, ncol = 1) +
  theme(legend.position = "bottom")
```

Extensions:

- Redo this analysis with the `r rdoc("rstanarm", "bball2006")` dataset with hits and at-bats for the entire 2006 AL season of MLB.
- Use a beta distribution for the prior of $\mu_i$. How would you specify the prior beta distribution so that it is uniformative?
- If you used the beta distribution, how would you specify the beta distribution as a function of the mean?
- The lowest batting average of the modern era is approximately 0.16 and the highest is approximately 0.4. Use this information for an informative prior distribuiton.
- There may be some truly exceptional players. Model this by replacing the normal prior for $\eta$ with a wide tailed distribution.
- The distribution of batting averages may be asymmetric - since there may be a few great players, but a player can only be so bad before they are relegated to the minor league. Find a skewed distribution to use as a prior.


References:

- Albert, Jim. [Revisiting Efron and Morrisâ€™s Baseball Study](https://baseballwithr.wordpress.com/2016/02/15/revisiting-efron-and-morriss-baseball-study/) Feb 15, 2016
- Bob Carpenter. [Hierarchical Bayesian Batting Ability, with Multiple Comparisons](https://lingpipe-blog.com/2009/11/04/hierarchicalbayesian-batting-ability-with-multiple-comparisons/). November 4, 2009.
- John Kruschke. [Shrinkage in multi-level hierarchical models](http://doingbayesiandataanalysis.blogspot.com/2012/11/shrinkage-in-multi-level-hierarchical.html). November 27, 2012.
- See @JensenMcShaneWyner2009a for an updated hierarchical model of baseball hitting

### Other Examples

- Rat Tumors - BDA
- Eight Schools - BDA


## Equivalent Models

### Group Varying Intercepts

This is a regression, with a different intercept per group:
$$
\begin{aligned}[t]
y_i &\sim \dnorm(\alpha_j[i] + \beta x_i, \sigma_y^2) \\
\end{aligned}
$$
The second level model of the group intercepts models them as distributed around a common mean, $\mu_\alpha$, with error:
$$
\alpha_j = \mu_\alpha + \eta_j \\
\eta_j \sim \dnorm(0, \sigma_\alpha^2)
$$

### Separate local regressions

For each group, run a regression,
$$
\begin{aligned}[t]
y_i \sim \dnorm(\alpha_j + \beta x_i, \sigma_y^2) & \text{for all $i$ in group $j$}
\end{aligned}
$$
And now model the group-level means,
$$
\begin{aligned}[t]
\alpha &= \dgamma u_j + \eta_j \\
\eta_j &\sim \dnorm(0, \sigma^2_\alpha)
\end{aligned}
$$


### Modeling the coefficients of a large regression model

Suppose that $X$ includes all predictors and $J$ indicators for the $J$ groups. 

We could also put the constant in the second distribution. The coefficients $\beta$ for the coefficients on the group indicators are centered around a $\mu_\alpha$.
$$
\begin{aligned}[t]
y_i &\sim \dnorm(x_i \beta, \sigma_y^2) \\
\beta_j &\sim \dnorm(\mu_{\alpha}, \sigma_{\alpha}^2)
\end{aligned}
$$

### Regression with multiple error terms

$$
\begin{aligned}[t]
y_i &\sim \dnorm(x_i \beta + \eta_{j[i]}, \sigma_y^2) \\
\eta_j &\sim \dnorm(0, \sigma_{\alpha}^2)
\end{aligned}
$$

### Regresion with correlated errors

$$
\begin{aligned}[t]
y_i &= X_i \beta + \omega_i, & \omega &\sim \dnorm(0, \Sigma)
\end{aligned}
$$
The errors have an $n \times n$ covariance matrix, and are
equivalent to the sum of individual and group errors.
$$
\omega_i = \eta_{j[i]} + \epsilon_i
$$

The variances and covariances in $\Sigma$ are:

- for unit $i$: $\Sigma_{ii} = \var(\omega_i) = \sigma_y^2 + \sigma_{\alpha}^2$
- for units $i$, $k$ in same group $j$: $\Sigma_{ik} = \cov(\omega_i, \omega_k) = \sigma_{\alpha}^2$
- for units $i$, $k$ in the same group $j$: $\Sigma_{ik} = 0$
