# Multilevel Models


## Example: Radon

This example models the presence of radon in houess in Minnesota which appears in @GelmanHill2007a and @BDA3.
This is partly derived from a [Stan Case Study](http://mc-stan.org/documentation/case-studies/radon.html), which uses `PyStan` instead of **rstan**.


### Data

The `r rdoc("rstanarm", "radon")` data is included in the `r rpkg("rstanarm")` package.
```{r}
data("radon", package = "rstanarm")
radon
```

The data consist of `r nrow(radon)`  observations of radon levels of houses from `r nlevels(radon$county)` counties.

```{r}
radon_county <- radon %>%
  group_by(county) %>%
  summarise(log_radon_mean = mean(log_radon),
            log_radon_sd = sd(log_radon), 
            log_uranium = mean(log_uranium),
            n = length(county))

```

```{r fig.asp=2}
ggplot() +
  geom_point(data = radon,
             mapping = aes(y = log_radon, x = fct_reorder(county, log_radon, mean))) +
  geom_point(data = radon_county,
             mapping = aes(x = fct_reorder(county, log_radon_mean), y = log_radon_mean),
             colour = "red") +
  coord_flip() + 
  labs(y = "log(radon)", x = "")
```

Relationship between mean and sample size
```{r}
ggplot(radon_county, aes(y = log_radon_mean, x = log2(n))) + 
  geom_point()
```

### Varying Intercepts Models

Consider the general model with an intercept for each county representing the baseline average of the county:
$$
\begin{aligned}
y_i &\sim  N(\mu_i, \sigma^2) \\
\mu_i &= \alpha_{j[i]} + \beta x_i
\end{aligned}
$$
where $j[i]$ means that observation $i$ is in county $j \in (1, \dots, `r nlevels(radon$county)`)$.

In this particular example, $y = \mathtt{log_radon}$ and $x = \mathtt{basement}$.
$$
\begin{aligned}
\mathtt{log\_radon}_i &\sim  N(\mu_i, \sigma^2) \\
\mu_i &= \alpha_{j[i]} + \beta~\mathtt{basement}_i
\end{aligned}
$$

We can put a prior distribution on $\alpha_{j[i]}$,
$$
\begin{aligned}[t]
\alpha_{j} &\sim N(\gamma, \tau) & \text{for $i \in (1, \dots, `r nlevels(radon$county)`)$}
\end{aligned}
$$
This parameterization nests common cases,

*Complete pooling:* When $\tau \to 0$, the intercepts are the same,
$$
\begin{aligned}[t]
\alpha_j &= \gamma  & \text{for all $j$.}
\end{aligned}
$$

*No pooling:* When $\tau \to \infty$, prior distribution on the intercepts is equivalent to an improper normal distribution, and there is no shrinkage,
$$
p(\alpha_j) \propto 1,
$$
for all $j$.

*Partial pooling:* When $\tau$ is a parameter, the amount of shrinkage can be estimated from the data.
A common prior is $\tau \sim N(0, 2.5)$,
$$
\tau \sim N^{+}(0, 2.5) .
$$

The partial pooling model 


### Varying Intercept Model


### Varying Slope Model


$$
\begin{aligned}
\mathtt{log\_radon}_i &\sim  N(\mu_i, \sigma^2) \\
\mu_i &= \alpha_{j[i]} + \beta_{j[i]}~\mathtt{basement}_i
\end{aligned}
$$


### Group Level Predictors

The `radon` dataset also contains the county-level measurements of `uranium`.

One way to include county level measurements is to model the county-level intercepts. 
The values of each county intercept is a function of the county-level uranium.
$$
\begin{aligned}
\mathtt{log\_radon}_i &\sim  N(\mu_i, \sigma^2) \\
\mu_i &= \alpha_{j[i]} + \beta_{j[i]}~\mathtt{basement}_i
\alpha_{j} \sim  N(\gamma_0 + \gamma_1~\mathtt{log\_uranium}_j, \tau)
\end{aligned}
$$


Alternatively, we can model model the county-level intercepts. 
The values of each county intercept is a function of the county-level uranium.
$$
\begin{aligned}
\mathtt{log\_radon}_i &\sim  N(\mu_i, \sigma^2) \\
\mu_i &= \alpha_{j[i]} + \beta_{j[i]}~\mathtt{basement}_i \\
\alpha_{j} &\sim  N(\gamma_0 + \gamma_1~\mathtt{log\_uranium}_j, \tau)
\end{aligned}
$$

### lme4

In R, the most widely used package to estimate mixed-effects models is **lme4**. 
This esimates models using maximum likelihood or restricted maximum likelihood methods (REML). 
This will be faster than using full-Bayesian methods but also underestimate the uncertainty, as well as being a worse approximation of the posterior.
Additionally, in frequentist inference, the meaning of the random effects is different; they are nuisance parameters and not given standard errors.

See @Bates2010a and @BatesMaechlerBolkerEtAl2014a for introductions to mixed-effects models with **lme4**.
These are also good introductions to classical approaches to mixed effects models.

```{r}
library("lme4")
```

Complete pooling
```{r}
fit_pooled <- lm(log_radon ~ county + floor, data = radon)
```
County-varying intercepts with no-pooling
```{r}
fit_intercept_nopool <- lm(log_radon ~ floor, data = radon)
```
County-varying intercepts with partial-pooling
```{r}
fit_intercept_partial <- lmer(log_radon ~ (1 | county) + floor, data = radon)
```
Varying slopes with no pooling:
```{r}
fit_slope_nopool <- lm(log_radon ~ county * floor, data = radon)
```
Varying slopes with partial pooling:
```{r}
fit_slope_partial <- lmer(log_radon ~ (1 + floor | county), data = radon)
```

Including a county-level variable (`log_uranium`) in various models:

With no-pooling,
```{r}
fit_slope_partial <- lm(log_radon ~ floor + log_uranium, data = radon)
```
With varying-intercepts
```{r}
fit_slope_partial <- lmer(log_radon ~ (1 | county) + floor + log_uranium, data = radon)
```
With varying-intercepts and slopes,
```{r}
fit_slope_partial <- lmer(log_radon ~ (1 + floor | county) +  log_uranium, data = radon)
```

### rstanarm

Some multilevel models can also be estimated using the **rstanarm** functions `stan_glmer` and `stan_lmer`.
These functions have syntax similar to **lme4** functions, but estimate the mixed models using Bayesian methods with Stan.

Complete pooling
```{r}
fit_pooled <- stan_glm(log_radon ~ county + floor, data = radon)
```
County-varying intercepts with no-pooling
```{r}
fit_intercept_nopool <- stan_glm(log_radon ~ floor, data = radon)
```
County-varying intercepts with partial-pooling
```{r}
fit_intercept_partial <- stan_glmer(log_radon ~ (1 | county) + floor, data = radon)
```
Varying slopes with no pooling:
```{r}
fit_slope_nopool <- stan_glm(log_radon ~ county * floor, data = radon)
```
Varying slopes with partial pooling:
```{r}
fit_slope_partial <- stan_glmer(log_radon ~ (1 + floor | county), data = radon)
```

Including a county-level variable (`log_uranium`) in various models:

With no-pooling,
```{r}
fit_slope_partial <- stan_glm(log_radon ~ floor + log_uranium, data = radon)
```
With varying-intercepts
```{r}
fit_slope_partial <- stan_glmr(log_radon ~ (1 | county) + floor + log_uranium, data = radon)
```
With varying-intercepts and slopes,
```{r}
fit_slope_partial <- stan_glmer(log_radon ~ (1 + floor | county) +  log_uranium, data = radon)
```

